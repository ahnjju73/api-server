<?xml version="1.0" encoding= "UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="leases.leases-payments">

    <resultMap id="bikeMap" type="hmap">
        <result property="bike_id" column="bike_id"/>
        <result property="bike_model" column="bike_model"/>
        <result property="bike_num" column="bike_num"/>
        <result property="bak_bike_id" column="bak_bike_id"/>
        <result property="bak_bike_num" column="bak_bike_num"/>
    </resultMap>

    <resultMap id="clientMap" type="hmap">
        <result property="client_id" column="client_id" />
        <result property="client_name" column="client_name"/>
    </resultMap>

    <resultMap id="fetchUnpaidLeases" type="hmap">
        <result property="row_num" column="row_num"/>
        <result property="lease_id" column="lease_id"/>
        <result property="bike_id" column="bike_id"/>
        <result property="client_id" column="client_id"/>
        <result property="unpaid_lease_fee" column="unpaid_lease_fee"/>
        <result property="unpaid_extra_fee" column="unpaid_extra_fee"/>
        <result property="unpaid_paid_fee" column="unpaid_paid_fee"/>
        <result property="lease_status" column="lease_stop_status"/>
        <collection property="bike" javaType="hmap" resultMap="bikeMap" />
        <collection property="client" javaType="hmap" resultMap="clientMap" />
    </resultMap>

    <select id="countAllLeaseExtrasGroupByClient" parameterType="hmap" resultType="int">
        select count(*)
          from (select sum(le.extra_fee) as extra_fee,
                       sum(le.paid_fee) as paid_fee,
                       lm.client_no
                  from (select *
                          from leases
                         where status = '550-003'
                           and contract_type = '500-001')lm
--                            and lease_stop_status in ('506-001', '506-003')
--                            and contract_type not in ('500-002')) lm
                       join (select *
                               from lease_payments
                              where 1 = 1
                              <if test="end_at != null and end_at != '' and end_at != 'undefined'">
                                and payment_date <![CDATA[ <= ]]> #{end_at}
                              </if>) lp on lm.lease_no = lp.lease_no
                       join (select *
                               from lease_extra
                              where 1 = 1
                                and extra_fee != paid_fee) le on lp.payment_no = le.payment_no
                 group by client_no) c
    </select>

    <select id="fetchLeaseExtrasGroupByClient" parameterType="hmap" resultType="hmap">
        select c.client_id,
               c.uuid,
               c.email,
               c.reg_no,
               ci.name as client_name,
               ci.phone as client_phone,
               if(ci.manager_name is null, '', ci.manager_name) as manager_name,
               if(ci.manager_email is null, '', ci.manager_email) as manager_email,
               if(ci.manager_phone is null, '', ci.manager_phone) as manager_phone,
               extra_fee,
               paid_fee
          from (select sum(le.extra_fee) as extra_fee,
                       sum(le.paid_fee) as paid_fee,
                       lm.client_no
                  from (select *
                          from leases
                         where status = '550-003'
                           and contract_type = '500-001') lm
                       join (select *
                               from lease_payments
                              where 1 = 1
                              <if test="end_at != null and end_at != '' and end_at != 'undefined'">
                                and payment_date <![CDATA[ <= ]]> #{end_at}
                              </if>) lp on lm.lease_no = lp.lease_no
                       join (select *
                               from lease_extra
                              where 1 = 1
                                and extra_fee != paid_fee) le on lp.payment_no = le.payment_no
                 group by client_no) m
             join clients c on m.client_no = c.client_no
             join client_info ci on ci.client_no = c.client_no
    </select>

    <select id="countAllLeasePaymentsGroupByClient" parameterType="hmap" resultType="int">
        select count(*)
          from (select *
                  from (select l.client_no
                          from (select *
                                  from leases
                                 where status = '550-003'
--                                    and lease_stop_status in ('506-001', '506-003')
                                   and contract_type = '500-001') l
                                join (select *
                                        from lease_payments
                                       where 1 = 1
                                    <if test="end_at != null and end_at != '' and end_at != 'undefined'">
                                        and payment_date <![CDATA[ <= ]]> #{end_at}
                                    </if>
                                    <if test="end_at == null or end_at == '' or end_at == 'undefined'">
                                        and date_format(payment_date, '%Y-%m-%d') <![CDATA[ <= ]]> #{now}
                                    </if>
                                         and lease_fee != paid_fee) lp on l.lease_no = lp.lease_no) l
          group by client_no) c
    </select>

    <select id="fetchLeasePaymentsGroupByClient" parameterType="hmap" resultType="hmap">
        select l.client_no,
               client_id,
               sum(l.lease_fee) as lease_fee,
               sum(l.paid_fee) as paid_fee,
               client_name,
               client_phone,
               manager_name,
               manager_email
         from (select l.*,
                      lp.payment_date,
                      lp.payment_id,
                      lp.idx,
                      lp.lease_fee,
                      lp.paid_fee,
                      client_id,
                      ci.name as client_name,
                      ci.phone as client_phone,
                      if(ci.manager_name is null, '', ci.manager_name) as manager_name,
                      if(ci.manager_email is null, '', ci.manager_email) as manager_email
                 from (select *
                         from leases
                        where status = '550-003'
--                           and lease_stop_status in ('506-001', '506-003')
                             and contract_type = '500-001') l
                      join (select *
                             from lease_payments
                             where 1 = 1
                             <if test="end_at != null and end_at != '' and end_at != 'undefined'">
                               and payment_date <![CDATA[ <= ]]> #{end_at}
                             </if>
                             <if test="end_at == null or end_at == '' or end_at == 'undefined'">
                                and date_format(payment_date, '%Y-%m-%d') <![CDATA[ <= ]]> #{now}
                             </if>
                               and lease_fee != paid_fee) lp on l.lease_no = lp.lease_no
                       join clients c on l.client_no = c.client_no
                       join client_info ci on c.client_no = ci.client_no) l
        group by client_no
    </select>

    <select id="countAllPaymentExtraByIndex" parameterType="hmap" resultType="int">
        select count(*)
          from (select *
                  from leases
                  where status = '550-003'
--                     and lease_stop_status in ('506-001', '506-003')
                    and contract_type = '500-001'
                    <if test="search_client_no != null">
                    and client_no = #{search_client_no}
                    </if>) lm
                     join (select *
                             from lease_payments
                            where 1 = 1
                            <if test="start_at != null and start_at != '' and start_at != 'undefined' and end_at != null and end_at != '' and end_at != 'undefined'">
                                and payment_date between #{start_at} and #{end_at}
                            </if>) lp on lm.lease_no = lp.lease_no
                     join (select *
                           from lease_extra
                           where 1 = 1
                            <if test='search_read == "N"'>
                             and read_yn = false
                            </if>
                             and extra_fee <![CDATA[ > ]]> paid_fee) le on lp.payment_no = le.payment_no
            order by lp.payment_date desc, lp.payment_no desc
    </select>

    <select id="fetchLeasePaymentExtraByIndex" parameterType="hmap" resultType="hmap">
        select cast(main.rownum as char) as rownum,
               main.lease_id,
               main.payment_id,
               date_format(main.payment_date, '%Y년%m월%d일') as payment_date,
               main.idx,
               main.extra_fee,
               main.paid_fee,
               main.extra_id,
               c.client_id,
               c.email as client_email,
               c.uuid as cleint_uuid,
               c.reg_no as client_reg_no,
               if(ci.name is null, '', ci.name) as client_name,
               if(ci.phone is null, '', ci.phone) as client_phone,
               if(b.bike_id in (SELECT val FROM system_parameters where parameter_no = 0), bak.bike_id, b.bike_id) as bike_id,
               b.vim_num,
               if(b.bike_id in (SELECT val FROM system_parameters where parameter_no = 0), bak.number, b.number) as number,
               cb.comm_nm as car_model,
               lp.payment_type,
               et.comm_nm as extra_type,
               main.read_yn as `read`,
               bum.user_id as read_user_id,
               bui.name as read_user_name,
               bum.email as read_user_email
          from (select *
                  from (select @rownum:=@rownum+1 as rownum,
                               dum.*
                          from (select lm.lease_id,
                                     lm.lease_no,
                                     lm.client_no,
                                     lm.bike_no,
                                     lm.bak_bike_no,
                                     lp.payment_date,
                                     lp.payment_id,
                                     le.extra_id,
                                     lp.idx,
                                     le.extra_fee,
                                     le.paid_fee,
                                     le.extra_type,
                                     le.read_yn,
                                     le.read_user_no
                                from (select *
                                        from leases
                                       where status = '550-003'
                                         and contract_type = '500-001'
--                                          and lease_stop_status in ('506-001', '506-003')
                                         <if test="search_client_no != null">
                                         and client_no = #{search_client_no}
                                         </if>) lm
                                     join (select *
                                             from lease_payments
                                            where 1 = 1
                                            <if test="start_at != null and start_at != '' and start_at != 'undefined' and end_at != null and end_at != '' and end_at != 'undefined'">
                                              and payment_date between #{start_at} and #{end_at}
                                            </if>) lp on lm.lease_no = lp.lease_no
                                     join (select *
                                             from lease_extra
                                            where 1 = 1
                                            <if test='search_read == "N"'>
                                              and read_yn = false
                                            </if>
                                              and extra_fee <![CDATA[ > ]]> paid_fee) le on lp.payment_no = le.payment_no
                              order by lp.payment_date desc, lp.payment_no desc) dum,
                              (SELECT @rownum :=0) AS R) lst
                        where 1 = 1
                        <if test="next_token != null and next_token != '' and next_token != 'undefined'">
                          and rownum <![CDATA[ > ]]> #{next_token}
                        </if>
                        order by rownum limit 30) main
                 join lease_price lp on main.lease_no = lp.lease_no
                 join clients c on main.client_no = c.client_no
                 join client_info ci on c.client_no = ci.client_no
                 join bikes b on main.bike_no = b.bike_no
                 left outer join bikes bak on bak.bike_no = main.bak_bike_no
                 join com_comm_bikes cb on b.car_model = cb.comm_cd
                 join (select *
                         from com_comm_mst
                        where up_comm_cd = 503) et on main.extra_type = et.comm_cd
                 left outer join bike_user_mst bum on main.read_user_no = bum.user_no
                 left outer join bike_user_info bui on bum.user_no = bui.user_no
        order by main.rownum
    </select>

    <select id="countAllPaymentsByIndex" parameterType="hmap" resultType="int">
        select count(*)
          from (select *
                  from leases
                 where status = '550-003'
                  <if test="search_client_no != null">
                   and client_no = #{search_client_no}
                  </if>
--                    and lease_stop_status in ('506-001', '506-003')
                   and contract_type = '500-001') l
                join (select *
                        from lease_payments
                       where date_format(payment_date, '%Y-%m-%d') <![CDATA[ <= ]]> now()
                        <if test='search_read == "N"'>
                         and `read_yn` = false
                        </if>
                        <if test="start_at != null and start_at != '' and start_at != 'undefined' and end_at != null and end_at != '' and end_at != 'undefined'">
                         and payment_date between #{start_at} and #{end_at}
                        </if>
                         and lease_fee <![CDATA[ > ]]> paid_fee) lp on l.lease_no = lp.lease_no
                <if test="search_bike != null and search_bike != '' and search_bike != 'undefined'">
                join (select *
                        from bikes
                       where 1 = 1
                         and ( `number` like concat('%', #{search_bike}, '%') or `vim_num` like concat('%', #{search_bike}, '%') )
                      ) b on l.bike_no = b.bike_no
                </if>

    </select>

    <select id="fetchLeasePaymentsByIndex" parameterType="hmap" resultType="hmap">
        select cast(dummy.rownum as char) as rownum,
               dummy.lease_id,
               dummy.payment_id,
               date_format(dummy.payment_date, '%Y년%m월%d일') as payment_date,
               dummy.idx,
               dummy.lease_fee,
               dummy.paid_fee,
               c.client_id,
               c.email as client_email,
               c.uuid as cleint_uuid,
               c.reg_no as client_reg_no,
               if(ci.name is null, '', ci.name) as client_name,
               if(ci.phone is null, '', ci.phone) as client_phone,
               dummy.bike_id,
               dummy.vim_num,
               dummy.number,
               cb.comm_nm as car_model,
               lp.payment_type,
               dummy.read_yn as `read`,
               bum.user_id as read_user_id,
               bui.name as read_user_name,
               bum.email as read_user_email
          from (select *
                  from (select @rownum:=@rownum+1 as rownum,
                                                    main.*
                          from (select l.*,
                                     lp.payment_date,
                                     lp.payment_id,
                                     lp.idx,
                                     lp.lease_fee,
                                     lp.paid_fee,
                                     lp.read_yn,
                                     lp.read_user_no,
                                     b.bike_id,
                                     b.vim_num,
                                     b.number,
                                     b.car_model
                                from (select *
                                        from leases
                                       where status = '550-003'
                                         <if test="search_client_no != null">
                                         and client_no = #{search_client_no}
                                         </if>
--                                          and lease_stop_status in ('506-001', '506-003')
                                         and contract_type = '500-001') l
                                     join (select *
                                             from bikes
                                            where 1 = 1
                                            <if test="search_bike != null and search_bike != '' and search_bike != 'undefined'">
                                              and ( `number` like concat('%', #{search_bike}, '%') or `vim_num` like concat('%', #{search_bike}, '%') )
                                            </if>
                                              ) b on l.bike_no = b.bike_no
                                     join (select *
                                             from lease_payments
                                            where date_format(payment_date, '%Y-%m-%d') <![CDATA[ <= ]]> now()
                                            <if test='search_read == "N"'>
                                              and `read_yn` = false
                                            </if>
                                            <if test="start_at != null and start_at != '' and start_at != 'undefined' and end_at != null and end_at != '' and end_at != 'undefined'">
                                              and payment_date between #{start_at} and #{end_at}
                                            </if>
                                              and lease_fee <![CDATA[ > ]]> paid_fee) lp on l.lease_no = lp.lease_no
                               order by lp.payment_date desc, lp.payment_id desc) main,
                               (SELECT @rownum :=0) AS R) dmy
                 where 1 = 1
                 <if test="next_token != null and next_token != '' and next_token != 'undefined'">
                   and rownum <![CDATA[ > ]]> #{next_token}
                 </if>
                 order by rownum limit 30) dummy
                join lease_price lp on dummy.lease_no = lp.lease_no
                join clients c on dummy.client_no = c.client_no
                join client_info ci on c.client_no = ci.client_no
                join com_comm_bikes cb on dummy.car_model = cb.comm_cd
                left outer join bike_user_mst bum on dummy.read_user_no = bum.user_no
                left outer join bike_user_info bui on bum.user_no = bui.user_no
        order by dummy.rownum
    </select>

    <select id="countAllLeasesUnpaidPayments" parameterType="hmap" resultType="int">
        select count(*)
          from (select count(*)
                  from (select *
                          from leases
                         where status = '550-003'
                           -- and lease_stop_status in ('506-001', '506-003')
                           and contract_type = '500-001') l
                  join (select payment_id, lease_no
                          from lease_payments
                         where lease_fee <![CDATA[ > ]]> paid_fee
                           and payment_date <![CDATA[ <= ]]> now()
                        ) lp on l.lease_no = lp.lease_no
        group by l.lease_id) c

    </select>

    <select id="fetchLeasesUnpaidPayments" parameterType="hmap" resultMap="fetchUnpaidLeases">
        select cast(main.rownum as char) as row_num,
               main.*,
               c.client_id,
               ci.name as client_name,
               b.bike_id,
               bak.bike_id as bak_bike_id,
               bak.number as bak_bike_num,
               b.number as bike_num,
               bm.comm_cd as bike_model,
               bm.comm_cd as bike_model
          from (select *
                  from (select  @rownum:=@rownum+1 as rownum, m.*
                           from (select l.*,
                                        sum(lease_fee) as unpaid_lease_fee,
                                        sum(paid_fee) as unpaid_paid_fee
                                   from (select lease_no,
                                                lease_id,
                                                lease_stop_status,
                                                bike_no,
                                                client_no,
                                                bak_bike_no
                                           from leases
                                          where `status` = '550-003'
                                            -- and lease_stop_status in ('506-001', '506-003')
                                            and contract_type = '500-001') l
                                        join lease_payments lp on lp.lease_no = l.lease_no
                                                              and payment_date <![CDATA[ <= ]]> now()
                                                              and lease_fee <![CDATA[ > ]]> paid_fee
                                  group by lease_id) m ,
                                (select @rownum:=0) as r
                          order by (unpaid_lease_fee - unpaid_paid_fee) desc) ma
                  where 1 = 1
                  <if test="next_token != null and next_token != '' and next_token != 'undefined'">
                    and rownum <![CDATA[ > ]]> #{next_token}
                  </if>
                  order by rownum limit 30) main
                join clients c on main.client_no = c.client_no
                join client_info ci on c.client_no = ci.client_no
                join bikes b on main.bike_no = b.bike_no
                left outer join bikes bak on bak.bike_no = main.bak_bike_no
                join com_comm_bikes bm on b.car_model = bm.comm_cd
         order by main.rownum
    </select>

    <select id="countAllLeasesUnpaidExtras" parameterType="hmap" resultType="int">
        select count(*)
          from (select count(*)
                  from (select *
                          from leases
                         where status = '550-003'
                           -- and lease_stop_status in ('506-001', '506-003')
                           and contract_type = '500-001') l
                       join (select payment_id,
                                    lease_no,
                                    payment_no
                               from lease_payments
                              where payment_date <![CDATA[ <= ]]> now()
                            ) lp on l.lease_no = lp.lease_no
                           join (select *
                                   from lease_extra) le on lp.payment_no = le.payment_no
                                                       and extra_fee <![CDATA[ > ]]> le.paid_fee
                 group by l.lease_id) c
    </select>

    <select id="fetchLeasesUnpaidExtras" parameterType="hmap" resultMap="fetchUnpaidLeases">
        select cast(main.rownum as char) as row_num,
               main.*,
               c.client_id,
               ci.name as client_name,
               b.bike_id,
               b.number as bike_num,
               bak.bike_id as bak_bike_id,
               bak.number as bak_bike_num,
               bm.comm_cd as bike_model,
               bm.comm_cd as bike_model
          from (select *
                  from (select  @rownum:=@rownum+1 as rownum, m.*
                           from (select l.*,
                                        sum(le.extra_fee) as unpaid_extra_fee,
                                        sum(le.paid_fee) as unpaid_paid_fee
                                   from (select lease_no,
                                                lease_id,
                                                lease_stop_status,
                                                bike_no,
                                                client_no,
                                                bak_bike_no
                                           from leases
                                          where `status` = '550-003'
                                            -- and lease_stop_status in ('506-001', '506-003')
                                            and contract_type = '500-001') l
                                join lease_payments lp on lp.lease_no = l.lease_no
                                                      and payment_date <![CDATA[ <= ]]> now()
                                join lease_extra le on le.payment_no = lp.payment_no
                                                      and extra_fee <![CDATA[ > ]]> le.paid_fee
                          group by lease_id) m ,
                        (select @rownum:=0) as r
                          order by (unpaid_extra_fee - unpaid_paid_fee) desc limit 30) ma
                       where 1 = 1
                       <if test="next_token != null and next_token != '' and next_token != 'undefined'">
                         and rownum <![CDATA[ > ]]> #{next_token}
                       </if>
                       order by rownum limit 30) main

              join clients c on main.client_no = c.client_no
              join client_info ci on c.client_no = ci.client_no
              join bikes b on main.bike_no = b.bike_no
              left outer join bikes bak on bak.bike_no = main.bak_bike_no
              join com_comm_bikes bm on b.car_model = bm.comm_cd
        order by main.rownum
    </select>

    <select id="countUnpaidLeaseExcel" parameterType="hmap" resultType="int">
        select count(*)
          from (select count(*)
                  from (select *
                          from leases
                         where `status` = '550-003'
                           -- and lease_stop_status in ('506-001', '506-003')
                           and contract_type = '500-001')l
                       join (select *
                               from lease_payments) lp on lp.lease_no = l.lease_no
                                                      and lease_fee <![CDATA[ > ]]> paid_fee
                                                    <if test="end_at != null and end_at != '' and end_at != 'undefined'">
                                                      and payment_date <![CDATA[ <= ]]> #{end_at}
                                                    </if>
                                                    <if test="end_at == null or end_at == '' or end_at == 'undefined'">
                                                      and payment_date <![CDATA[ <= ]]> now()
                                                    </if>
                              group by lease_id) lm
    </select>

    <select id="fetchUnpaidLeaseExcel" parameterType="hmap" resultType="hmap">
        select lm.*,
               b.bike_id,
               c.client_id,
               b.bike_id,
               bak.bike_id as bak_bike_id,
               bak.number as bak_bike_num,
               b.number,
               ci.name
          from (select l.lease_no,
                       lease_id,
                       l.client_no,
                       l.bike_no,
                       l.bak_bike_no,
                       sum(lease_fee) as leasefee,
                       sum(paid_fee) as paidfee,
                       sum(lease_fee - paid_fee) as unpaidfee
                  from (select *
                          from leases
                         where `status` = '550-003'
                           -- and lease_stop_status in ('506-001', '506-003')
                           and contract_type = '500-001')l
                       join lease_payments lp on l.lease_no = lp.lease_no
                                             and lease_fee <![CDATA[ > ]]> paid_fee
                                           <if test="end_at != null and end_at != '' and end_at != 'undefined'">
                                             and payment_date <![CDATA[ <= ]]> #{end_at}
                                           </if>
                                           <if test="end_at == null or end_at == '' or end_at == 'undefined'">
                                             and payment_date <![CDATA[ <= ]]> now()
                                           </if>
                group by lease_no
                order by unpaidfee desc) lm
              join clients c on c.client_no = lm.client_no
              join client_info ci on ci.client_no = c.client_no
              join bikes b on lm.bike_no = b.bike_no
              left outer join bikes bak on bak.bike_no = lm.bak_bike_no
    </select>

    <select id="countUnpaidExtraExcel" parameterType="hmap" resultType="int">
        select count(*)
          from (select count(*)
                  from (select *
                          from leases
                         where `status` = '550-003'
                           -- and lease_stop_status in ('506-001', '506-003')
                           and contract_type = '500-001')l
                        join (select payment_no,
                                     payment_id,
                                     lease_no,
                                     payment_date
                                from lease_payments) lp on lp.lease_no = l.lease_no
                                                     <if test="end_at != null and end_at != '' and end_at != 'undefined'">
                                                       and payment_date <![CDATA[ <= ]]> #{end_at}
                                                     </if>
                                                     <if test="end_at == null or end_at == '' or end_at == 'undefined'">
                                                       and payment_date <![CDATA[ <= ]]> now()
                                                     </if>
                        join (select extra_fee,
                                     payment_no,
                                     paid_fee
                                from lease_extra)le on le.payment_no = lp.payment_no
                                                   and extra_fee <![CDATA[ > ]]> paid_fee
                 group by lease_id) lm
    </select>

    <select id="fetchUnpaidExtraExcel" parameterType="hmap" resultType="hmap">
        select lm.*,
               b.bike_id,
               c.client_id,
               b.bike_id,
               b.number,
               bak.bike_id as bak_bike_id,
               bak.number as bak_bike_num,
               ci.name
          from (select l.lease_no,
                       lease_id,
                       l.client_no,
                       l.bike_no,
                       l.bak_bike_no,
                       sum(le.extra_fee) as extrafee,
                       sum(le.paid_fee) as paidfee,
                       sum(le.extra_fee - le.paid_fee) as unpaidfee
                  from (select *
                 from  leases
                 where `status` = '550-003'
                   -- and lease_stop_status in ('506-001', '506-003')
                   and contract_type = '500-001')l
                 join lease_extra le on l.lease_no = le.lease_no
                                    and le.extra_fee <![CDATA[ > ]]> le.paid_fee
                 join lease_payments lp on l.lease_no = lp.lease_no
                                     <if test="end_at != null and end_at != '' and end_at != 'undefined'">
                                       and payment_date <![CDATA[ <= ]]> #{end_at}
                                     </if>
                                     <if test="end_at == null or end_at == '' or end_at == 'undefined'">
                                       and payment_date <![CDATA[ <= ]]> now()
                                     </if>
                                       and lp.payment_no = le.payment_no
                 group by lease_no
                 order by unpaidfee desc) lm
               join clients c on c.client_no = lm.client_no
               join client_info ci on ci.client_no = c.client_no
               join bikes b on lm.bike_no = b.bike_no
               left outer join bikes bak on bak.bike_no = lm.bak_bike_no
    </select>

    <select id="countAllManagementLeasesUnpaidPayments" parameterType="hmap" resultType="int">
        select count(*)
        from (select count(*)
              from (select *
                    from leases
                    where status = '550-003'
                      -- and lease_stop_status in ('506-001', '506-003')
                      and contract_type = '500-002') l
              join (select payment_id, lease_no
                      from lease_payments
                     where date_format(payment_date, '%Y-%m-%d') <![CDATA[ <= ]]> #{now}
                       and lease_fee <![CDATA[ > ]]> paid_fee) lp on l.lease_no = lp.lease_no
       group by l.lease_id) c
    </select>

    <select id="fetchManagementLeasesUnpaidPayments" parameterType="hmap" resultMap="fetchUnpaidLeases">
        select cast(main.rownum as char) as row_num,
               main.*,
               c.client_id,
               ci.name as client_name,
               b.bike_id,
               b.number as bike_num,
               bak.bike_id as bak_bike_id,
               bak.number as bak_bike_num,
               bm.comm_cd as bike_model,
               bm.comm_cd as bike_model
          from (select *
                  from (select  @rownum:=@rownum+1 as rownum, m.*
                           from (select l.*,
                                        sum(lease_fee) as unpaid_lease_fee,
                                        sum(paid_fee) as unpaid_paid_fee
                                   from (select lease_no,
                                                lease_id,
                                                bike_no,
                                                client_no,
                                                bak_bike_no
                                           from leases
                                          where `status` = '550-003'
                                            -- and lease_stop_status in ('506-001', '506-003')
                                            and contract_type = '500-002') l
                                           join lease_payments lp on lp.lease_no = l.lease_no
                                                                 and payment_date <![CDATA[ <= ]]> #{now}
                                                                 and lease_fee <![CDATA[ > ]]> paid_fee
                                          group by lease_id) m ,
                                (select @rownum:=0) as r
                          order by (unpaid_lease_fee - unpaid_paid_fee) desc) ma
                          where 1 = 1
                          <if test="next_token != null and next_token != '' and next_token != 'undefined'">
                            and rownum <![CDATA[ > ]]> #{next_token}
                          </if>
                          order by rownum
                          <if test="excel != null and excel != '' and excel != 'undefined'">
                          limit 30
                          </if>) main
          join clients c on main.client_no = c.client_no
          join client_info ci on c.client_no = ci.client_no
          join bikes b on main.bike_no = b.bike_no
          left outer join bikes bak on bak.bike_no = main.bak_bike_no
          join com_comm_bikes bm on b.car_model = bm.comm_cd
         order by main.rownum
    </select>

    <select id="countAllManagementExtraUnpaidPayments" parameterType="hmap" resultType="int">
        select count(*)
          from (select *
          from leases
         where status = '550-003'
           -- and lease_stop_status in ('506-001', '506-003')
           and contract_type = '500-002'
         <if test="search_client_no != null">
           and client_no = #{search_client_no}
         </if>) lm
          join (select *
                  from lease_payments
                 where 1 = 1
                 <if test="start_at != null and start_at != '' and start_at != 'undefined' and end_at != null and end_at != '' and end_at != 'undefined'">
                   and payment_date between #{start_at} and #{end_at}
                 </if>) lp on lm.lease_no = lp.lease_no
          join (select *
                  from lease_extra
                 where extra_fee <![CDATA[ > ]]> paid_fee) le on lp.payment_no = le.payment_no
    </select>

    <select id="fetchManagementExtraUnpaidPayments" parameterType="hmap" resultType="hmap">
        select cast(main.rownum as char) as rownum,
               main.lease_id,
               main.payment_id,
               date_format(main.payment_date, '%Y년%m월%d일') as payment_date,
               main.idx,
               main.extra_fee,
               main.paid_fee,
               main.extra_id,
               c.client_id,
               c.email as client_email,
               c.uuid as cleint_uuid,
               c.reg_no as client_reg_no,
               if(ci.name is null, '', ci.name) as client_name,
               if(ci.phone is null, '', ci.phone) as client_phone,
               b.bike_id,
               b.vim_num,
               b.number,
               bak.bike_id as bak_bike_id,
               bak.number as bak_bike_num,
               cb.comm_nm as car_model,
               lp.payment_type,
               et.comm_nm as extra_type,
               main.read_yn as `read`,
               bum.user_id as read_user_id,
               bui.name as read_user_name,
               bum.email as read_user_email
          from (select *
                  from (select @rownum:=@rownum+1 as rownum,
                               dum.*
                          from (select lm.lease_id,
                                       lm.lease_no,
                                       lm.client_no,
                                       lm.bike_no,
                                       lm.bak_bike_no,
                                       lp.payment_date,
                                       lp.payment_id,
                                       le.extra_id,
                                       lp.idx,
                                       le.extra_fee,
                                       le.paid_fee,
                                       le.extra_type,
                                       le.read_yn,
                                       le.read_user_no
                                  from (select *
                                          from leases
                                         where status = '550-003'
                                           and contract_type = '500-002'
                                           -- and lease_stop_status in ('506-001', '506-003')
                                         <if test="search_client_no != null">
                                           and client_no = #{search_client_no}
                                         </if>) lm
                                  join (select *
                                          from lease_payments
                                         where 1 = 1
                                         <if test="start_at != null and start_at != '' and start_at != 'undefined' and end_at != null and end_at != '' and end_at != 'undefined'">
                                           and payment_date between #{start_at} and #{end_at}
                                         </if>) lp on lm.lease_no = lp.lease_no
                                  join (select *
                                          from lease_extra
                                         where 1 = 1
                                         <if test='search_read == "N"'>
                                           and read_yn = false
                                         </if>
                                           and extra_fee <![CDATA[ > ]]> paid_fee) le on lp.payment_no = le.payment_no
                                 order by lp.payment_date desc, lp.payment_no desc) dum,
                                       (SELECT @rownum :=0) AS R) lst
                                 where 1 = 1
                                 <if test="next_token != null and next_token != '' and next_token != 'undefined'">
                                   and rownum <![CDATA[ > ]]> #{next_token}
                                 </if>
                                 order by rownum limit 30) main
          join lease_price lp on main.lease_no = lp.lease_no
          join clients c on main.client_no = c.client_no
          join client_info ci on c.client_no = ci.client_no
          join bikes b on main.bike_no = b.bike_no
          left outer join bikes bak on main.bak_bike_no = bak.bike_no
          join com_comm_bikes cb on b.car_model = cb.comm_cd
          join (select *
                  from com_comm_mst
                 where up_comm_cd = 503) et on main.extra_type = et.comm_cd
          left outer join bike_user_mst bum on main.read_user_no = bum.user_no
          left outer join bike_user_info bui on bum.user_no = bui.user_no
         order by main.rownum
    </select>



    <select id="countAllUnpaidStopLeases" parameterType="hmap" resultType="int">
        select count(*)
          from (select *
                  from leases
                 where lease_stop_status = '506-002'
                   and stop_fee <![CDATA[ > ]]> stop_paid_fee)l
    </select>

    <select id="fetchAllUnpaidStopLeases" parameterType="hmap" resultType="hmap">
        select main.*,
               b.number,
               b.car_model,
               b.bike_id,
               c.client_id,
               ci.name
          from (select cast(m.rownum as char) as row_num,
                       m.*
                  from (select @rownum:=@rownum+1 as rownum,
                               l.*
                          from (select lease_id,
                                       client_no,
                                       bike_no,
                                       contract_type,
                                       management_type,
                                       `status`,
                                       bak_bike_no,
                                       lease_stop_status,
                                       stop_fee,
                                       stop_paid_fee
                                  from leases
                                 where lease_stop_status = '506-002'
                                   and stop_fee <![CDATA[ > ]]> stop_paid_fee) l,
                               (select @rownum:=0) as r) m
                         where 1 = 1
                         <if test="next_token != null and next_token != '' and next_token != 'undefined'">
                           and rownum <![CDATA[ > ]]> #{next_token}
                         </if>
                         order by rownum limit 30) main
          join bikes b on b.bike_no = main.bak_bike_no
          join clients c on main.client_no = c.client_no
          join client_info ci on c.client_no = ci.client_no
    </select>
</mapper>