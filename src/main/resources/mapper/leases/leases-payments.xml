<?xml version="1.0" encoding= "UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="leases.leases-payments">

    <select id="countAllPaymentsByIndex" parameterType="hmap" resultType="int">
        select count(*)
          from (select *
                  from leases
                 where status = '550-003') l
                join (select *
                        from lease_payments
                       where date_format(payment_date, '%Y-%m-%d') <![CDATA[ <= ]]> #{now}
                        <if test="start_at != null and start_at != '' and start_at != 'undefined' and end_at != null and end_at != '' and end_at != 'undefined'">
                         and payment_date between #{start_at} and #{end_at}
                        </if>
                         and lease_fee != paid_fee) lp on l.lease_no = lp.lease_no
    </select>

    <select id="fetchLeasePaymentsByIndex" parameterType="hmap" resultType="hmap">
        select cast(dummy.rownum as char) as rownum,
               dummy.lease_id,
               dummy.payment_id,
               date_format(dummy.payment_date, '%Y년%m월%d일') as payment_date,
               dummy.idx,
               dummy.lease_fee,
               dummy.paid_fee,
               c.client_id,
               c.email as client_email,
               c.uuid as cleint_uuid,
               c.reg_no as client_reg_no,
               if(ci.name is null, '', ci.name) as client_name,
               if(ci.phone is null, '', ci.phone) as client_phone,
               b.bike_id,
               b.vim_num,
               b.number,
               cb.comm_nm as car_model,
               lp.payment_type
        from (select *
                from (select @rownum:=@rownum+1 as rownum,
					         main.*
                        from (select l.*,
                                     lp.payment_date,
                                     lp.payment_id,
                                     lp.idx,
                                     lp.lease_fee,
                                     lp.paid_fee
                                from (select *
                                        from leases
                                       where status = '550-003') l
                                     join (select *
                                             from lease_payments
                                            where date_format(payment_date, '%Y-%m-%d') <![CDATA[ <= ]]> #{now}
                                          <if test="start_at != null and start_at != '' and start_at != 'undefined' and end_at != null and end_at != '' and end_at != 'undefined'">
                                              and payment_date between #{start_at} and #{end_at}
                                          </if>
                                              and lease_fee != paid_fee) lp on l.lease_no = lp.lease_no
                               order by lp.payment_date desc, lp.payment_id desc) main,
                               (SELECT @rownum :=0) AS R) dmy
                where 1 = 1
                <if test="next_token != null and next_token != '' and next_token != 'undefined'">
                  and rownum <![CDATA[ > ]]> #{next_token}
                </if>
                order by rownum limit 30) dummy
               join lease_price lp on dummy.lease_no = lp.lease_no
               join clients c on dummy.client_no = c.client_no
               join client_info ci on c.client_no = ci.client_no
               join bikes b on dummy.bike_no = b.bike_no
               join com_comm_bikes cb on b.car_model = cb.comm_cd
        order by dummy.rownum
    </select>

</mapper>