<?xml version="1.0" encoding= "UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="leases.leases-payments">

    <select id="countAllLeaseExtrasGroupByClient" parameterType="hmap" resultType="int">
        select count(*)
          from (select lp.payment_date,
                       sum(le.extra_fee) as extra_fee,
                       sum(le.paid_fee) as paid_fee,
                       lm.client_no
                  from (select *
                          from leases
                         where status = '550-003') lm
                       join (select *
                               from lease_payments
                              where 1 = 1
                              <if test="start_at != null and start_at != '' and start_at != 'undefined' and end_at != null and end_at != '' and end_at != 'undefined'">
                                and payment_date between #{end_at} and #{start_at}
                              </if>) lp on lm.lease_no = lp.lease_no
                       join (select *
                               from lease_extra
                              where 1 = 1
                                and extra_fee != paid_fee) le on lp.payment_no = le.payment_no
                 group by client_no) c
    </select>

    <select id="fetchLeaseExtrasGroupByClient" parameterType="hmap" resultType="hmap">
        select c.client_id,
               c.uuid,
               c.email,
               c.reg_no,
               ci.name as client_name,
               ci.phone as client_phone,
               if(ci.manager_name is null, '', ci.manager_name) as manager_name,
               if(ci.manager_email is null, '', ci.manager_email) as manager_email,
               if(ci.manager_phone is null, '', ci.manager_phone) as manager_phone,
               et.comm_nm as extra_type,
               extra_fee,
               paid_fee
          from (select lp.payment_date,
                       sum(le.extra_fee) as extra_fee,
                       sum(le.paid_fee) as paid_fee,
                       lm.client_no,
                       le.extra_type
                  from (select *
                          from leases
                         where status = '550-003') lm
                       join (select *
                               from lease_payments
                              where 1 = 1
                              <if test="start_at != null and start_at != '' and start_at != 'undefined' and end_at != null and end_at != '' and end_at != 'undefined'">
                                and payment_date between #{end_at} and #{start_at}
                              </if>) lp on lm.lease_no = lp.lease_no
                       join (select *
                               from lease_extra
                              where 1 = 1
                                and extra_fee != paid_fee) le on lp.payment_no = le.payment_no
                 group by client_no) m
             join clients c on m.client_no = c.client_no
             join client_info ci on ci.client_no = c.client_no
             join (select *
                     from com_comm_mst
                    where up_comm_cd = 503) et on m.extra_type = et.comm_cd
    </select>

    <select id="countAllLeasePaymentsGroupByClient" parameterType="hmap" resultType="int">
        select count(*)
          from (select *
                  from (select l.client_no
                          from (select *
                                  from leases
                                 where status = '550-003') l
                                join (select *
                                        from lease_payments
                                       where 1 = 1
                                    <if test="start_at != null and start_at != '' and start_at != 'undefined' and end_at != null and end_at != '' and end_at != 'undefined'">
                                        and payment_date between #{end_at} and #{start_at}
                                    </if>
                                    <if test="start_at == null or start_at == '' or start_at == 'undefined' or end_at == null or end_at == '' or end_at == 'undefined'">
                                        and date_format(payment_date, '%Y-%m-%d') <![CDATA[ <= ]]> #{now}
                                    </if>
                                         and lease_fee != paid_fee) lp on l.lease_no = lp.lease_no) l
          group by client_no) c
    </select>

    <select id="fetchLeasePaymentsGroupByClient" parameterType="hmap" resultType="hmap">
        select l.client_no,
               client_id,
               sum(l.lease_fee) as lease_fee,
               sum(l.paid_fee) as paid_fee,
               client_name,
               client_phone,
               manager_name,
               manager_email
         from (select l.*,
                      lp.payment_date,
                      lp.payment_id,
                      lp.idx,
                      lp.lease_fee,
                      lp.paid_fee,
                      client_id,
                      ci.name as client_name,
                      ci.phone as client_phone,
                      if(ci.manager_name is null, '', ci.manager_name) as manager_name,
                      if(ci.manager_email is null, '', ci.manager_email) as manager_email
                 from (select *
                         from leases
                        where status = '550-003') l
                      join (select *
                             from lease_payments
                             where 1 = 1
                             <if test="start_at != null and start_at != '' and start_at != 'undefined' and end_at != null and end_at != '' and end_at != 'undefined'">
                               and payment_date between #{end_at} and #{start_at}
                             </if>
                             <if test="start_at == null or start_at == '' or start_at == 'undefined' or end_at == null or end_at == '' or end_at == 'undefined'">
                                and date_format(payment_date, '%Y-%m-%d') <![CDATA[ <= ]]> #{now}
                             </if>
                               and lease_fee != paid_fee) lp on l.lease_no = lp.lease_no
                       join clients c on l.client_no = c.client_no
                       join client_info ci on c.client_no = ci.client_no) l
        group by client_no
    </select>

    <select id="countAllPaymentExtraByIndex" parameterType="hmap" resultType="int">
        select count(*)
          from (select *
                  from leases
                  where status = '550-003') lm
                     join (select *
                             from lease_payments
                            where 1 = 1
                            <if test="start_at != null and start_at != '' and start_at != 'undefined' and end_at != null and end_at != '' and end_at != 'undefined'">
                                and payment_date between #{end_at} and #{start_at}
                            </if>) lp on lm.lease_no = lp.lease_no
                     join (select *
                           from lease_extra
                           where 1 = 1
                             and extra_fee != paid_fee) le on lp.payment_no = le.payment_no
            order by lp.payment_date desc, lp.payment_no desc
    </select>

    <select id="fetchLeasePaymentExtraByIndex" parameterType="hmap" resultType="hmap">
        select cast(main.rownum as char) as rownum,
               main.lease_id,
               main.payment_id,
               date_format(main.payment_date, '%Y년%m월%d일') as payment_date,
               main.idx,
               main.extra_fee,
               main.paid_fee,
               main.extra_id,
               c.client_id,
               c.email as client_email,
               c.uuid as cleint_uuid,
               c.reg_no as client_reg_no,
               if(ci.name is null, '', ci.name) as client_name,
               if(ci.phone is null, '', ci.phone) as client_phone,
               b.bike_id,
               b.vim_num,
               b.number,
               cb.comm_nm as car_model,
               lp.payment_type,
               et.comm_nm as extra_type
        from (select *
                from (select @rownum:=@rownum+1 as rownum,
                             dum.*
                        from (select lm.lease_id,
                                     lm.lease_no,
                                     lm.client_no,
                                     lm.bike_no,
                                     lp.payment_date,
                                     lp.payment_id,
                                     le.extra_id,
                                     lp.idx,
                                     le.extra_fee,
                                     le.paid_fee,
                                     le.extra_type
                                from (select *
                                        from leases
                                       where status = '550-003') lm
                                     join (select *
                                             from lease_payments
                                            where 1 = 1
                                            <if test="start_at != null and start_at != '' and start_at != 'undefined' and end_at != null and end_at != '' and end_at != 'undefined'">
                                              and payment_date between #{end_at} and #{start_at}
                                            </if>) lp on lm.lease_no = lp.lease_no
                                     join (select *
                                             from lease_extra
                                            where 1 = 1
                                              and extra_fee != paid_fee) le on lp.payment_no = le.payment_no
                              order by lp.payment_date desc, lp.payment_no desc) dum,
                              (SELECT @rownum :=0) AS R) lst
                        where 1 = 1
                        <if test="next_token != null and next_token != '' and next_token != 'undefined'">
                          and rownum <![CDATA[ > ]]> #{next_token}
                        </if>
                        order by rownum limit 30) main
                 join lease_price lp on main.lease_no = lp.lease_no
                 join clients c on main.client_no = c.client_no
                 join client_info ci on c.client_no = ci.client_no
                 join bikes b on main.bike_no = b.bike_no
                 join com_comm_bikes cb on b.car_model = cb.comm_cd
                 join (select *
                         from com_comm_mst
                        where up_comm_cd = 503) et on main.extra_type = et.comm_cd
        order by main.rownum
    </select>

    <select id="countAllPaymentsByIndex" parameterType="hmap" resultType="int">
        select count(*)
          from (select *
                  from leases
                 where status = '550-003') l
                join (select *
                        from lease_payments
                       where date_format(payment_date, '%Y-%m-%d') <![CDATA[ <= ]]> #{now}
                        <if test="search_read != null and search_read != 'undefined' and search_read != ''">
                         and `read_yn` = 0
                        </if>
                        <if test="start_at != null and start_at != '' and start_at != 'undefined' and end_at != null and end_at != '' and end_at != 'undefined'">
                         and payment_date between #{end_at} and #{start_at}
                        </if>
                         and lease_fee != paid_fee) lp on l.lease_no = lp.lease_no
    </select>

    <select id="fetchLeasePaymentsByIndex" parameterType="hmap" resultType="hmap">
        select cast(dummy.rownum as char) as rownum,
               dummy.lease_id,
               dummy.payment_id,
               date_format(dummy.payment_date, '%Y년%m월%d일') as payment_date,
               dummy.idx,
               dummy.lease_fee,
               dummy.paid_fee,
               c.client_id,
               c.email as client_email,
               c.uuid as cleint_uuid,
               c.reg_no as client_reg_no,
               if(ci.name is null, '', ci.name) as client_name,
               if(ci.phone is null, '', ci.phone) as client_phone,
               b.bike_id,
               b.vim_num,
               b.number,
               cb.comm_nm as car_model,
               lp.payment_type,
               dummy.read_yn as `read`,
               bum.user_id as read_user_id,
               bui.name as read_user_name,
               bum.email as read_user_email
          from (select *
                  from (select @rownum:=@rownum+1 as rownum,
				  	           main.*
                          from (select l.*,
                                     lp.payment_date,
                                     lp.payment_id,
                                     lp.idx,
                                     lp.lease_fee,
                                     lp.paid_fee,
                                     lp.read_yn,
                                     lp.read_user_no
                                from (select *
                                        from leases
                                       where status = '550-003') l
                                     join (select *
                                             from lease_payments
                                            where date_format(payment_date, '%Y-%m-%d') <![CDATA[ <= ]]> #{now}
                                            <if test="search_read != null and search_read != 'undefined' and search_read != ''">
                                              and `read_yn` = 0
                                            </if>
                                            <if test="start_at != null and start_at != '' and start_at != 'undefined' and end_at != null and end_at != '' and end_at != 'undefined'">
                                              and payment_date between #{end_at} and #{start_at}
                                            </if>
                                              and lease_fee != paid_fee) lp on l.lease_no = lp.lease_no
                               order by lp.payment_date desc, lp.payment_id desc) main,
                               (SELECT @rownum :=0) AS R) dmy
                where 1 = 1
                <if test="next_token != null and next_token != '' and next_token != 'undefined'">
                  and rownum <![CDATA[ > ]]> #{next_token}
                </if>
                order by rownum limit 30) dummy
               join lease_price lp on dummy.lease_no = lp.lease_no
               join clients c on dummy.client_no = c.client_no
               join client_info ci on c.client_no = ci.client_no
               join bikes b on dummy.bike_no = b.bike_no
               join com_comm_bikes cb on b.car_model = cb.comm_cd
               left outer join bike_user_mst bum on dummy.read_user_no = bum.user_no
               left outer join bike_user_info bui on bum.user_no = bui.user_no
        order by dummy.rownum
    </select>

</mapper>